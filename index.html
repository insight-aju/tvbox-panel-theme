<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Painel de Audio_2.1</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <!--
  Versao_2.1: tudo funcionando, e com acesso externo com link atualizavel 
    Pagina: index.html
    Funcao:
      - Painel principal de audio para LAS CABANAS DEL CONDE.
      - Controle de volume master, ambientes (Quiosque/Piscina) e reles.
      - Acesso rapido a aplicativos (YouTube, video de boas-vindas, Home, Iniciar/Encerrar show).
    Endpoints principais (ver servidor Python):
      - /api/vol,  /api/vol/set, /api/mute
      - /api/status       -> estado do ESP (volumes, mute, reles)
      - /api/gpio         -> aciona reles (Painel de LED, sistema de som, etc.)
      - /api/ir           -> comandos IR (QUIOSQUE/PISCINA, MUTE/VOL_UP/VOL_DOWN)
      - /api/youtube      -> abre YouTube no BTV
      - /api/welcome      -> toca video de boas-vindas
      - /api/home         -> comando HOME (retorno)
      - /api/startshow    -> fluxo Iniciar (reles + boas-vindas + YouTube)
      - /api/stopshow     -> fluxo Encerrar (reles + HOME)
  -->
  <header>
    <strong data-i18n="brand">LAS CABANAS DEL CONDE - Painel de Audio</strong>
    <nav><a href="esp.html" data-i18n="config">Config</a></nav>

    <!-- Seletor de idioma (mesma estrutura de esp.html)
         Estilos: ver style.css, secao "SELECIONADOR DE IDIOMA" -->
    <div class="lang-picker" role="group" aria-label="Idioma">
      <button class="lang-btn" data-lang="pt" title="Portugues (Brasil)">
        <span class="lang-flag" aria-hidden="true">ðŸ‡§ðŸ‡·</span>
        <span class="lang-code">BR</span>
      </button>
      <button class="lang-btn" data-lang="es" title="Espanol">
        <span class="lang-flag" aria-hidden="true">ðŸ‡ªðŸ‡¸</span>
        <span class="lang-code">ES</span>
      </button>
      <button class="lang-btn" data-lang="en" title="English">
        <span class="lang-flag" aria-hidden="true">ðŸ‡ºðŸ‡¸</span>
        <span class="lang-code">EN</span>
      </button>
      <button class="lang-btn" data-lang="fr" title="Francais">
        <span class="lang-flag" aria-hidden="true">ðŸ‡«ðŸ‡·</span>
        <span class="lang-code">FR</span>
      </button>
      <button class="lang-btn" data-lang="it" title="Italiano">
        <span class="lang-flag" aria-hidden="true">ðŸ‡®ðŸ‡¹</span>
        <span class="lang-code">IT</span>
      </button>
      <button class="lang-btn" data-lang="de" title="Deutsch">
        <span class="lang-flag" aria-hidden="true">ðŸ‡©ðŸ‡ª</span>
        <span class="lang-code">DE</span>
      </button>
    </div>
<!-- Seletor compacto (mobile retrato) -->
<label class="lang-select-wrap" aria-label="Idioma">
  <select id="langSelect" class="lang-select" aria-label="Idioma">
    <option value="pt">ðŸ‡§ðŸ‡· BR</option>
    <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
    <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
    <option value="fr">ðŸ‡«ðŸ‡· FR</option>
    <option value="it">ðŸ‡®ðŸ‡¹ IT</option>
    <option value="de">ðŸ‡©ðŸ‡ª DE</option>
  </select>
</label>


    <!-- Status simples do backend (online/offline)
         Atualizado em refresh() via tStatusOnline()/tStatusOffline() -->
    <span id="status" class="muted" style="margin-left:auto">-</span>
  </header>

  <main class="wrap">
    <!-- ===================== CARD: APLICATIVOS ===================== -->
    <section class="card">
      <h3 style="margin-top:0" data-i18n="appsTitle">Aplicativos</h3>
      <div class="row app-row">
        <!-- ESQUERDA: Bem-vindo / YouTube -->
        <div class="app-left">
          <!-- Botao do video de boas-vindas -->
          <button class="btn" id="btnWelcome" data-i18n="openWelcome">Bem-vindo</button>
          <!-- Botao para abrir YouTube -->
          <button class="btn" id="btnYouTube" data-i18n="openYouTube">Abrir YouTube</button>
        </div>

        <!-- CENTRO: Retorno (comando "HOME" do BTV) -->
        <div class="app-center">
          <button class="btn" id="btnHome" data-i18n="openHome">Retorno</button>
        </div>

        <!-- DIREITA: Iniciar / Encerrar show -->
        <div class="app-right">
          <button class="btn" id="btnStartShow" data-i18n="openStartShow">Iniciar</button>
          <button class="btn" id="btnStopShow" data-i18n="openStopShow">Encerrar</button>
        </div>
      </div>
    </section>

    <!-- ===================== CARD: VOLUME MASTER ===================== -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h3 style="margin:0" data-i18n="masterTitle">Principal (<span id="stream">-</span>)</h3>
          <div class="muted" data-i18n="masterSubtitle">Controle geral <code>- volume</code></div>
        </div>
        <div class="muted" data-i18n="maxLabel">max: <span id="maxInfo">-</span></div>
      </div>

      <div class="grid">
        <div class="volNum" id="volPct">0%</div>
        <input id="slider" type="range" min="0" max="25" value="0" step="1">
        <div class="row">
          <button class="btn btn-danger" id="btnMute" data-i18n="mute">Mudo</button>
          <span class="muted" id="absInfo" data-i18n="absInfo">
            valor: <span data-i18n-slot="valabs">0/0</span>
          </span>
        </div>
      </div>
    </section>

    <!-- ===================== CARD: CONTROLES POR AMBIENTES ===================== -->
    <section class="card">
      <h3 style="margin-top:0" data-i18n="perAreaTitle">Controles por ambientes</h3>
      <div class="row">
        <div class="control-group">
          <h4 data-i18n="kiosk">Quiosque</h4>
          <input type="range" id="vol-quiosque" min="0" max="30" value="0">
          <div class="volNum" id="quiosque-val">--%</div>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-danger" id="btnMuteQuiosque" data-i18n="mute">Mudo</button>
          </div>
        </div>

        <div class="control-group">
          <h4 data-i18n="pool">Piscina</h4>
          <input type="range" id="vol-piscina" min="0" max="30" value="0">
          <div class="volNum" id="piscina-val">--%</div>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-danger" id="btnMutePiscina" data-i18n="mute">Mudo</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== CARD: CONTROLE DE ACIONAMENTOS ===================== -->
    <section class="card">
      <h3 style="margin-top:0" data-i18n="relayTitle">Controle de acionamentos</h3>
      <div style="margin-bottom: 10px;">
        <span data-i18n="esp32">Controle:</span>
        <span id="esp32-comm-status"><span class="status-text"></span></span>
      </div>
      <div class="relay-controls">
        <button class="btn relay-toggle" id="r1" data-i18n="r1">Painel de LED</button>
        <button class="btn relay-toggle" id="r2" data-i18n="r2">Sistema de som</button>
        <button class="btn relay-toggle" id="r3" data-i18n="r3">VÃ­deo 1</button>
        <button class="btn relay-toggle" id="r4" data-i18n="r4">SaudaÃ§Ã£o</button>
      </div>
    </section>
  </main>

<!-- === I18N core para index.html (textos de interface em varios idiomas) === -->
<script>
const I18N = {
  pt: {
    brand: "LAS CABANAS DEL CONDE - Painel de Audio",
    config: "Config",
    online: "Ativo", offline: "Desativado",
    masterTitle: "Principal (<span id='stream'>-</span>)",
    masterSubtitle: "Controle geral <code>- volume</code>",
    maxLabel: "max: <span id='maxInfo'>-</span>",
    mute: "Mudo",
    absInfo: "valor: <span data-i18n-slot='valabs'>-/-</span>",
    perAreaTitle: "Controles por ambientes",
    kiosk: "Quiosque",
    pool: "Piscina",
    relayTitle: "Controle de acionamentos",
    esp32: "Controle:",
    r1: "Painel de LED",
    r2: "Sistema de som",
    r3: "VÃ­deo 1",
    r4: "SaudaÃ§Ã£o",
    appsTitle: "Aplicativos",
    openYouTube: "Abrir YouTube",
    openWelcome: "Bem-vindo",
    openHome: "Retorno",
    openStartShow: "Iniciar",
    openStopShow: "Encerrar"
  },
  es: {
    brand: "LAS CABANAS DEL CONDE - Panel de Audio",
    config: "Config",
    online: "En linea", offline: "Desconectado",
    masterTitle: "Principal (<span id='stream'>-</span>)",
    masterSubtitle: "Control general <code>- volumen</code>",
    maxLabel: "max: <span id='maxInfo'>-</span>",
    mute: "Silenciar",
    absInfo: "valor: <span data-i18n-slot='valabs'>-/-</span>",
    perAreaTitle: "Controles por ambientes",
    kiosk: "Quiosco",
    pool: "Piscina",
    relayTitle: "Control de accionamientos",
    esp32: "Control:",
    r1: "Panel de LED",
    r2: "Sistema de sonido",
    r3: "Video 1",
    r4: "Saludo",
    appsTitle: "Aplicaciones",
    openYouTube: "Abrir YouTube",
    openWelcome: "Bienvenido",
    openHome: "Volver",
    openStartShow: "Iniciar",
    openStopShow: "Finalizar"
  },
  en: {
    brand: "LAS CABANAS DEL CONDE - Audio Panel",
    config: "Config",
    online: "Online", offline: "Offline",
    masterTitle: "Master (<span id='stream'>-</span>)",
    masterSubtitle: "Master control <code>- volume</code>",
    maxLabel: "max: <span id='maxInfo'>-</span>",
    mute: "Mute",
    absInfo: "value: <span data-i18n-slot='valabs'>-/-</span>",
    perAreaTitle: "Per-area controls",
    kiosk: "Kiosk",
    pool: "Pool",
    relayTitle: "Relay control",
    esp32: "Control:",
    r1: "LED panel",
    r2: "Sound system",
    r3: "Video 1",
    r4: "Greeting",
    appsTitle: "Applications",
    openYouTube: "Open YouTube",
    openWelcome: "Welcome",
    openHome: "Return",
    openStartShow: "Start show",
    openStopShow: "Stop show"
  },
  fr: {
    brand: "LAS CABANAS DEL CONDE - Panneau audio",
    config: "Parametres",
    online: "En ligne", offline: "Hors ligne",
    masterTitle: "Principal (<span id='stream'>-</span>)",
    masterSubtitle: "Controle general <code>- volume</code>",
    maxLabel: "max: <span id='maxInfo'>-</span>",
    mute: "Muet",
    absInfo: "valeur: <span data-i18n-slot='valabs'>-/-</span>",
    perAreaTitle: "Controles par zone",
    kiosk: "Kiosque",
    pool: "Piscine",
    relayTitle: "Controle des actionnements",
    esp32: "Controle:",
    r1: "Panneau LED",
    r2: "Systeme audio",
    r3: "VidÃ©o 1",
    r4: "Salutation",
    appsTitle: "Application",
    openYouTube: "Ouvrir YouTube",
    openWelcome: "Accueil",
    openHome: "Retour",
    openStartShow: "Demarrer",
    openStopShow: "Arreter"
  },
  it: {
    brand: "LAS CABANAS DEL CONDE - Pannello audio",
    config: "Impostazioni",
    online: "Attivo", offline: "Disattivato",
    masterTitle: "Principale (<span id='stream'>-</span>)",
    masterSubtitle: "Controllo generale <code>- volume</code>",
    maxLabel: "max: <span id='maxInfo'>-</span>",
    mute: "Muto",
    absInfo: "valore: <span data-i18n-slot='valabs'>-/-</span>",
    perAreaTitle: "Controlli per ambiente",
    kiosk: "Chiosco",
    pool: "Piscina",
    relayTitle: "Controllo attuazioni",
    esp32: "Controllo:",
    r1: "Pannello LED",
    r2: "Sistema audio",
    r3: "Video 1",
    r4: "Saluto",
    appsTitle: "Applicazione",
    openYouTube: "Apri YouTube",
    openWelcome: "Benvenuto",
    openHome: "Ritorno",
    openStartShow: "Avvia",
    openStopShow: "Termina"
  },
  de: {
    brand: "LAS CABANAS DEL CONDE - Audio-Panel",
    config: "Einstellungen",
    online: "Aktiv", offline: "Deaktiviert",
    masterTitle: "Hauptansicht (<span id='stream'>-</span>)",
    masterSubtitle: "Gesamtsteuerung <code>- Lautstaerke</code>",
    maxLabel: "max: <span id='maxInfo'>-</span>",
    mute: "Stumm",
    absInfo: "Wert: <span data-i18n-slot='valabs'>-/-</span>",
    perAreaTitle: "Bereichssteuerungen",
    kiosk: "Kiosk",
    pool: "Pool",
    relayTitle: "Schaltsteuerung",
    esp32: "Kontrolle:",
    r1: "LED-Panel",
    r2: "Soundsystem",
    r3: "Video 1",
    r4: "BegrÃ¼ÃŸung",
    appsTitle: "Anwendung",
    openYouTube: "YouTube oeffnen",
    openWelcome: "Willkommen",
    openHome: "Zuruck",
    openStartShow: "Starten",
    openStopShow: "Beenden"
  }
};

/* Idioma atual compartilhado com esp.html */
let LANG = localStorage.getItem('lang') || (navigator.language || 'pt').slice(0, 2);
if (!I18N[LANG]) LANG = 'pt';

function applyI18n(){
  const map = I18N[LANG];

  document.querySelectorAll('.lang-btn').forEach(b=>{
    b.setAttribute('aria-current', b.dataset.lang === LANG ? 'true' : 'false');
  });

    const sel = document.getElementById('langSelect');
  if (sel) sel.value = LANG;

document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (map[key] !== undefined){
      el.innerHTML = map[key];
    }
  });

  const stEl = document.querySelector('#esp32-comm-status .status-text');
  if (stEl){
    const isOnline = stEl.dataset.state === 'on';
    stEl.textContent = isOnline ? map.online : map.offline;
  }

  const abs = document.querySelector('#absInfo [data-i18n-slot="valabs"]');
  if (abs && typeof STATE?.value === 'number' && typeof STATE?.max === 'number'){
    abs.textContent = `${STATE.value}/${STATE.max}`;
  }
}

document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.lang-btn');
  if (!btn) return;
  LANG = btn.dataset.lang;
  localStorage.setItem('lang', LANG);
  applyI18n();
});


document.addEventListener('change', (e)=>{
  const sel = e.target.closest('#langSelect');
  if (!sel) return;
  LANG = sel.value;
  localStorage.setItem('lang', LANG);
  applyI18n();
});
function tStatusOnline(){ return I18N[LANG].online; }
function tStatusOffline(){ return I18N[LANG].offline; }

document.addEventListener('DOMContentLoaded', applyI18n);
</script>

<!-- === Logica principal do painel (volumes, reles, apps) === -->
<script>
const $ = sel => document.querySelector(sel);

let STATE = { stream: 'music', value: 0, max: 25 };
let dragging = { master: false, quiosque: false, piscina: false };

let espState = {
  volumes: { quiosque: 0, piscina: 0 },
  relays:  { r1: 0, r2: 0, r3: 0, r4: 0 },
  mute_state: { QUIOSQUE: false, PISCINA: false }
};

function pct(){ return Math.round(STATE.value * 100 / STATE.max); }

function updateUI(){
  $('#stream').textContent  = STATE.stream;
  $('#maxInfo').textContent = STATE.max;
  $('#volPct').textContent  = pct() + '%';

  const abs = document.querySelector('#absInfo [data-i18n-slot="valabs"]');
  if (abs) abs.textContent = `${STATE.value}/${STATE.max}`;

  if (!dragging.master){
    const s = $('#slider');
    s.max   = STATE.max;
    s.value = STATE.value;
  }
}

async function api(path, method = 'GET', body = null, timeoutMs = 4000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);

  const opt = { method, headers: {'Content-Type': 'application/json'}, signal: controller.signal };
  if (body) opt.body = JSON.stringify(body);

  try{
    const r = await fetch(path, opt);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return await r.json();
  } finally {
    clearTimeout(t);
  }
}

async function refresh(){
  try {
    const j = await api('/api/vol','GET',null,2500);
    STATE = j;
    updateUI();
    $('#status').textContent = tStatusOnline();
  } catch {
    $('#status').textContent = tStatusOffline();
  }
}

async function pollESPStatus(){
  // one-shot update (nÃ£o agenda loop aqui)
  if (window._espPollInFlight) return !!window._espLastOnline;
  window._espPollInFlight = true;
  let isOnline = false;

  try{
    const j = await api('/api/status','GET',null,3500);
    if(!j.ok) throw new Error('Status error');
    const st = j.state || {};

    // ONLINE real vem do servidor (nÃ£o dÃ¡ pra inferir sÃ³ por "ip")
    isOnline = (st.online === true);

    // Atualiza indicador principal (card "Controle de acionamentos")
    const stTxt = $('#esp32-comm-status .status-text');
    stTxt.textContent = isOnline ? tStatusOnline() : tStatusOffline();
    stTxt.style.color = isOnline ? 'lime' : 'red';
    stTxt.dataset.state = isOnline ? 'on' : 'off';

    // Controles por ambiente (Quiosque/Piscina)
    if(isOnline && st.volumes){
      const quiosqueMuted = (st.mute_state||st.ir_mutes)?.QUIOSQUE === true;
      const piscinaMuted  = (st.mute_state||st.ir_mutes)?.PISCINA  === true;

      // Quiosque
      const volQuiosque = quiosqueMuted ? 0 : st.volumes.quiosque;
      if(!dragging.quiosque){
        $('#vol-quiosque').value = volQuiosque;
      }
      $('#quiosque-val').textContent = st.volumes.quiosque;
      const qm = $('#quiosque-mute-indicator');
      if (qm) qm.style.display = quiosqueMuted ? 'inline' : 'none';

      // Piscina
      const volPiscina = piscinaMuted ? 0 : st.volumes.piscina;
      if(!dragging.piscina){
        $('#vol-piscina').value = volPiscina;
      }
      $('#piscina-val').textContent = st.volumes.piscina;
      const pm = $('#piscina-mute-indicator');
      if (pm) pm.style.display = piscinaMuted ? 'inline' : 'none';
    } else {
      // Sem comunicaÃ§Ã£o: mostra "--" (indicador claro no card por ambiente)
      $('#quiosque-val').textContent = '--';
      $('#piscina-val').textContent  = '--';
      const qm = $('#quiosque-mute-indicator'); if (qm) qm.style.display = 'none';
      const pm = $('#piscina-mute-indicator');  if (pm) pm.style.display = 'none';
    }

    // RelÃ©s (mantÃ©m atualizaÃ§Ã£o sÃ³ quando ONLINE, para nÃ£o "inventar" estado)
    if (isOnline && st.relays){
      for (const id of ['r1','r2']){
        const b = $('#' + id);
        if (!b) continue;
        const on = !!st.relays[id];
        b.classList.toggle('active', on);
        b.setAttribute('aria-pressed', on);
      }
    }

    // r3/r4 agora sao acoes de video (nao sao reles) - nao mantem estado "active"
    for (const vidId of ['r3','r4']){
      const vb = $('#' + vidId);
      if (vb){
        vb.classList.remove('active');
        vb.setAttribute('aria-pressed', 'false');
      }
    }

    espState = st;
  } catch (e) {
    // Falhou o /api/status (rede/servidor). Aqui sim Ã© erro de fetch.
    const stTxt = $('#esp32-comm-status .status-text');
    stTxt.textContent = tStatusOffline();
    stTxt.style.color = 'red';
    stTxt.dataset.state = 'off';

    $('#quiosque-val').textContent = '--';
    $('#piscina-val').textContent  = '--';
    const qm = $('#quiosque-mute-indicator'); if (qm) qm.style.display = 'none';
    const pm = $('#piscina-mute-indicator');  if (pm) pm.style.display = 'none';

    isOnline = false;
  } finally {
    window._espLastOnline = isOnline;
    window._espPollInFlight = false;
  }

  return isOnline;
}

// Loop adaptativo: ONLINE -> 1s | OFFLINE -> 3s (evita spam quando o controlador cai)
window._espPollTimer = null;
window._espPollInFlight = false;
window._espLastOnline = false;

function _scheduleEspPoll(delayMs){
  if (window._espPollTimer) clearTimeout(window._espPollTimer);
  window._espPollTimer = setTimeout(async ()=>{
    const online = await pollESPStatus();
    const nextDelay = document.hidden ? 8000 : (online ? 1000 : 3000);
    _scheduleEspPoll(nextDelay);
  }, delayMs);
}

function startEspPoll(){
  _scheduleEspPoll(200);
}


function debounce(fn, ms){
  let t = null;
  return (...a)=>{
    clearTimeout(t);
    t = setTimeout(()=>fn(...a), ms);
  };
}

const sendSlider = debounce(async (v)=>{
  try {
    await api('/api/vol/set','POST',{ value: v });
    setTimeout(()=>{ dragging.master = false; refresh(); }, 200);
  } catch {
    dragging.master = false;
    alert('Falha ao ajustar volume');
  }
}, 100);

async function setRelay(id, on){
  const map = { r1: 23, r2: 22 };
  const pin = map[id];
  if (!pin) return;
  try {
    const r = await api('/api/gpio', 'POST', { pin, state: on ? 1 : 0 });
    if (r.ok) await pollESPStatus();
  } catch (e) {
    console.error('Erro ao controlar rele:', e);
  }
}

async function sendIR(dev, cmd){
  try {
    const r = await api('/api/ir', 'POST', { device: dev, command: cmd });
    if (r.ok) await pollESPStatus();
  } catch (e) {
    console.error('Erro ao enviar IR:', e);
  }
}

async function playVideo(key){
  const j = await api('/api/playvideo','POST',{ key }, 12000);
  if (!j.ok) throw new Error(j.out || 'falha');
}

$('#slider').addEventListener('input', e=>{
  dragging.master = true;
  const v = Number(e.target.value);
  STATE.value = v;
  updateUI();
  sendSlider(v);
});

$('#btnMute').onclick = async ()=>{
  try {
    await api('/api/mute','POST',{});
    await refresh();
  } catch {
    alert('Falha no mute');
  }
};

$('#btnMuteQuiosque').onclick = async ()=>{
  try {
    await sendIR('QUIOSQUE','MUTE');
  } catch {
    alert('Falha no mute do Quiosque');
  }
};

$('#btnMutePiscina').onclick = async ()=>{
  try {
    await sendIR('PISCINA','MUTE');
  } catch {
    alert('Falha no mute da Piscina');
  }
};

$('#vol-quiosque').addEventListener('input', e=>{
  dragging.quiosque = true;
  $('#quiosque-val').textContent = e.target.value;
});

$('#vol-quiosque').addEventListener('change', async ()=>{
  dragging.quiosque = false;
  const newVal = Number($('#vol-quiosque').value);
  const currentMuteState = (espState.mute_state||espState.ir_mutes)?.QUIOSQUE === true;

  if (currentMuteState){
    await sendIR('QUIOSQUE', 'MUTE');
  }

  const realOldVal = espState.volumes.quiosque;
  const diff = newVal - realOldVal;

  if (diff !== 0){
    const cmd = diff > 0 ? 'VOL_UP' : 'VOL_DOWN';
    const steps = Math.abs(diff);
    for (let i = 0; i < steps; i++){
      await sendIR('QUIOSQUE', cmd);
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }
});

$('#vol-piscina').addEventListener('input', e=>{
  dragging.piscina = true;
  $('#piscina-val').textContent = e.target.value;
});

$('#vol-piscina').addEventListener('change', async ()=>{
  dragging.piscina = false;
  const newVal = Number($('#vol-piscina').value);
  const currentMuteState = (espState.mute_state||espState.ir_mutes)?.PISCINA === true;

  if (currentMuteState){
    await sendIR('PISCINA', 'MUTE');
  }

  const realOldVal = espState.volumes.piscina;
  const diff = newVal - realOldVal;

  if (diff !== 0){
    const cmd = diff > 0 ? 'VOL_UP' : 'VOL_DOWN';
    const steps = Math.abs(diff);
    for (let i = 0; i < steps; i++){
      await sendIR('PISCINA', cmd);
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }
});

document.querySelectorAll('.relay-toggle').forEach(button => {
  button.addEventListener('click', async () => {
    const id = button.id;

    // r1/r2 seguem como reles (toggle)
    if (id === 'r1' || id === 'r2'){
      const isActive = button.classList.contains('active');
      await setRelay(id, !isActive);
      return;
    }

    // r3/r4 viraram acoes de video (momentaneas)
    try {
      if (id === 'r3') await playVideo('video1');
      else if (id === 'r4') await playVideo('saudacao');
    } catch {
      alert('Falha ao executar a acao de video');
    }
  });
});

$('#btnYouTube').onclick = async ()=>{
  try {
    const j = await api('/api/youtube','POST',{}, 12000);
    if (!j.ok) throw new Error(j.out || 'falha');
  } catch {
    alert('Falha ao abrir YouTube');
  }
};

$('#btnWelcome').onclick = async ()=>{
  try {
    const j = await api('/api/welcome','POST',{}, 12000);
    if (!j.ok) throw new Error(j.out || 'falha');
  } catch (e){
    alert('Falha ao abrir video de boas-vindas');
  }
};

$('#btnHome').onclick = async ()=>{
  try {
    const j = await api('/api/home','POST',{}, 12000);
    if (!j.ok) throw new Error(j.out || 'falha');
  } catch {
    alert('Falha ao enviar comando Retorno');
  }
};

$('#btnStartShow').onclick = async ()=>{
  try {
    await setRelay('r1', true);
    await setRelay('r2', true);

    const j = await api('/api/startshow','POST',{ delay_s: 45 }, 20000);
    if (!j.video_ok) throw new Error(j.out || 'falha');
    if (j.timer_ok === false) console.warn('Iniciou, mas falhou agendamento do YouTube.', j);
  } catch(e){
    alert('Falha ao iniciar show');
    console.error(e);
  }
};

$('#btnStopShow').onclick = async ()=>{
  try {
    const j = await api('/api/stopshow','POST',{}, 12000);
    if (!j.ok) throw new Error(j.out || 'falha');
  } catch(e){
    alert('Falha ao encerrar show');
    console.error(e);
  }
};

// -------------------- Poll loops (com pausa/slowdown em background) --------------------
let _volPollTimer = null;

function _scheduleVolPoll(delayMs){
  if (_volPollTimer) clearTimeout(_volPollTimer);
  _volPollTimer = setTimeout(async ()=>{
    try{
      if (!dragging.master){
        await refresh();
      }
    } catch (e){
      // refresh() jÃ¡ cuida de status online/offline
    } finally {
      const nextDelay = document.hidden ? 8000 : 1500;
      _scheduleVolPoll(nextDelay);
    }
  }, delayMs);
}

function startVolPoll(){
  _scheduleVolPoll(200);
}

function stopVolPoll(){
  if (_volPollTimer) clearTimeout(_volPollTimer);
  _volPollTimer = null;
}

function stopEspPoll(){
  if (window._espPollTimer) clearTimeout(window._espPollTimer);
  window._espPollTimer = null;
}

// Quando a aba fica em segundo plano, reduz bastante a taxa de polling.
// Quando volta para o foreground, forÃ§a uma atualizaÃ§Ã£o rÃ¡pida.
document.addEventListener('visibilitychange', ()=>{
  if (!document.hidden){
    refresh();               // atualiza logo ao voltar
    startVolPoll();          // retoma rÃ¡pido
    startEspPoll();          // retoma rÃ¡pido
  } else {
    startVolPoll();          // reprograma (vai cair em 8s)
    startEspPoll();          // reprograma (vai cair em 8s)
  }
});

window.addEventListener('online', ()=>{
  refresh();
  startEspPoll();
});

window.addEventListener('offline', ()=>{
  $('#status').textContent = tStatusOffline();
});

// Limpa timers ao sair/navegar pra evitar loops duplicados
window.addEventListener('pagehide', ()=>{
  stopVolPoll();
  stopEspPoll();
});

// Boot
refresh();
startVolPoll();
startEspPoll();
</script>
</body>
</html>
